<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Scan Results Dashboard</h1>
    <div>
      <button id="sync-metadata-btn" class="btn btn-outline-primary">
        <i class="bi bi-arrow-repeat"></i> Sync Metadata
      </button>
      <a href="/scan" class="btn btn-primary ms-2">
        <i class="bi bi-plus-lg"></i> New Scan
      </a>
    </div>
  </div>
  
  <!-- Search and Filter Form -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <div class="d-flex justify-content-between align-items-center">
        <span><i class="bi bi-search"></i> Search & Filter Reports</span>
        <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#searchCollapse" aria-expanded="false">
          <i class="bi bi-chevron-down"></i>
        </button>
      </div>
    </div>
    <div class="collapse show" id="searchCollapse">
      <div class="card-body">
        <form id="search-form" method="GET" action="/dashboard">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="search-query" class="form-label">Search Term</label>
              <input type="text" class="form-control" id="search-query" name="query" placeholder="Search by scan ID, title or target URL" value="{{query}}">
            </div>
            <div class="col-md-3">
              <label for="search-severity" class="form-label">Vulnerability Severity</label>
              <select class="form-select" id="search-severity" name="severity">
                <option value="" {{#unless severity}}selected{{/unless}}>All Severities</option>
                <option value="Critical" {{#if (eq severity "Critical")}}selected{{/if}}>Critical</option>
                <option value="High" {{#if (eq severity "High")}}selected{{/if}}>High</option>
                <option value="Medium" {{#if (eq severity "Medium")}}selected{{/if}}>Medium</option>
                <option value="Low" {{#if (eq severity "Low")}}selected{{/if}}>Low</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="search-enhanced" class="form-label">Enhancement Status</label>
              <select class="form-select" id="search-enhanced" name="enhanced">
                <option value="" {{#unless enhanced}}selected{{/unless}}>All</option>
                <option value="true" {{#if (eq enhanced "true")}}selected{{/if}}>Enhanced</option>
                <option value="false" {{#if (eq enhanced "false")}}selected{{/if}}>Not Enhanced</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="search-date-from" class="form-label">Date From</label>
              <input type="date" class="form-control" id="search-date-from" name="dateFrom" value="{{dateFrom}}">
            </div>
            <div class="col-md-4">
              <label for="search-date-to" class="form-label">Date To</label>
              <input type="date" class="form-control" id="search-date-to" name="dateTo" value="{{dateTo}}">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="d-grid gap-2 w-100">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-search"></i> Search
                </button>
                <a href="/dashboard" class="btn btn-outline-secondary">
                  <i class="bi bi-x-circle"></i> Clear Filters
                </a>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="sync-status" class="alert alert-info d-none" role="alert">
    Synchronizing metadata...
  </div>

  {{#if scans.length}}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Scan ID</th>
            <th>Title</th>
            <th>Target URL</th>
            <th>Date</th>
            <th>Vulnerabilities</th>
            <th>Enhanced</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {{#each scans}}
            <tr data-scan-id="{{scanId}}">
              <td>
                <div><code>{{scanId}}</code></div>
              </td>
              <td>{{title}}</td>
              <td>{{targetUrl}}</td>
              <td>{{formatDate timestamp}}</td>
              <td>
                {{#if vulnerabilityCount}}
                  <span class="badge bg-{{#if (gt vulnerabilityCount 0)}}danger{{else}}success{{/if}}">
                    {{vulnerabilityCount}}
                  </span>
                {{else}}
                  <span class="badge bg-secondary">Unknown</span>
                {{/if}}
              </td>
              <td>
                {{#if (eq enhanced "true")}}
                  <span class="badge bg-success">
                    <i class="bi bi-check"></i> {{provider}} {{model}}
                  </span>
                {{else}}
                  <span class="badge bg-secondary">No</span>
                {{/if}}
              </td>
              <td>
                <div class="btn-group">
                  <a href="/dashboard/scan/{{scanId}}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-info-circle"></i> Details
                  </a>
                  <a href="/results/{{scanId}}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-file-text"></i> Results
                  </a>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      {{#if (eq enhanced "true")}}
                        <li>
                          <a class="dropdown-item" href="/reports/{{#if actualScanId}}{{actualScanId}}{{else}}{{scanId}}{{/if}}/edit">
                            <i class="bi bi-pencil"></i> Edit Report
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item" href="/results/{{#if actualScanId}}{{actualScanId}}{{else}}{{scanId}}{{/if}}/enhance">
                            <i class="bi bi-arrow-repeat"></i> Re-enhance
                          </a>
                        </li>
                      {{else}}
                        <li>
                          <a class="dropdown-item" href="/results/{{#if actualScanId}}{{actualScanId}}{{else}}{{scanId}}{{/if}}/enhance">
                            <i class="bi bi-stars"></i> Enhance with LLM
                          </a>
                        </li>
                      {{/if}}
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="dropdown-item" href="/reports/report_{{#if actualScanId}}{{actualScanId}}{{else}}{{scanId}}{{/if}}.html" target="_blank">
                          <i class="bi bi-box-arrow-up-right"></i> View Report
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="/api/results/{{scanId}}/download">
                          <i class="bi bi-file-earmark-text"></i> Download Results
                        </a>
                      </li>
                      {{#if (eq enhanced "true")}}
                      <li>
                        <a class="dropdown-item" href="/api/results/{{scanId}}/download?enhanced=true">
                          <i class="bi bi-file-earmark-richtext"></i> Download Enhanced Results
                        </a>
                      </li>
                      {{/if}}
                      <li>
                        <a class="dropdown-item" href="/reports/report_{{scanId}}.html" download="report_{{scanId}}.html">
                          <i class="bi bi-file-earmark-code"></i> Download Report
                        </a>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal{{scanId}}">
                          <i class="bi bi-trash"></i> Delete Scan
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
                
                <!-- Delete Confirmation Modal for each scan -->
                <div class="modal fade" id="deleteConfirmModal{{scanId}}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Confirm Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <p>Are you sure you want to delete this scan and all associated files?</p>
                        <p><strong>Scan ID:</strong> <code>{{scanId}}</code></p>
                        <p><strong>Title:</strong> {{title}}</p>
                        <p class="text-danger"><strong>Warning:</strong> This action cannot be undone.</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="deleteScan('{{scanId}}')">Delete Permanently</button>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>

    {{!-- Pagination --}}
    <nav aria-label="Scan results pagination">
      <ul class="pagination justify-content-center">
        <li class="page-item {{#if (eq pagination.page 1)}}disabled{{/if}}">
          <a class="page-link" href="/dashboard?page={{subtract pagination.page 1}}&limit={{pagination.limit}}{{#if query}}&query={{query}}{{/if}}{{#if enhanced}}&enhanced={{enhanced}}{{/if}}{{#if severity}}&severity={{severity}}{{/if}}{{#if dateFrom}}&dateFrom={{dateFrom}}{{/if}}{{#if dateTo}}&dateTo={{dateTo}}{{/if}}">Previous</a>
        </li>
        <li class="page-item active">
          <span class="page-link">{{pagination.page}}</span>
        </li>
        <li class="page-item {{#unless pagination.hasMore}}disabled{{/unless}}">
          <a class="page-link" href="/dashboard?page={{add pagination.page 1}}&limit={{pagination.limit}}{{#if query}}&query={{query}}{{/if}}{{#if enhanced}}&enhanced={{enhanced}}{{/if}}{{#if severity}}&severity={{severity}}{{/if}}{{#if dateFrom}}&dateFrom={{dateFrom}}{{/if}}{{#if dateTo}}&dateTo={{dateTo}}{{/if}}">Next</a>
        </li>
      </ul>
    </nav>
  {{else}}
    <div class="alert alert-info" role="alert">
      <h4 class="alert-heading">No scan results found!</h4>
      <p>It looks like you haven't run any scans yet, or the metadata needs to be synchronized.</p>
      <hr>
      <p class="mb-0">
        <a href="/scan" class="btn btn-primary">
          <i class="bi bi-play"></i> Run a New Scan
        </a>
        <button id="sync-metadata-btn-empty" class="btn btn-outline-secondary ms-2">
          <i class="bi bi-arrow-repeat"></i> Sync Metadata
        </button>
      </p>
    </div>
  {{/if}}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Search form functionality
    const searchForm = document.getElementById('search-form');
    const dateFromInput = document.getElementById('search-date-from');
    const dateToInput = document.getElementById('search-date-to');
    
    // Date validation
    if (searchForm) {
      searchForm.addEventListener('submit', function(e) {
        // Validate date range if both dates are provided
        if (dateFromInput.value && dateToInput.value) {
          const dateFrom = new Date(dateFromInput.value);
          const dateTo = new Date(dateToInput.value);
          
          if (dateFrom > dateTo) {
            e.preventDefault();
            alert('The From date must be earlier than or equal to the To date');
            return false;
          }
        }
      });
    }
    
    // Sync metadata button functionality
    const syncButtons = document.querySelectorAll('#sync-metadata-btn, #sync-metadata-btn-empty');
    const syncStatus = document.getElementById('sync-status');
    
    syncButtons.forEach(button => {
      button.addEventListener('click', async function() {
        try {
          // Show syncing status
          syncStatus.classList.remove('d-none');
          syncStatus.classList.remove('alert-danger');
          syncStatus.classList.add('alert-info');
          syncStatus.textContent = 'Synchronizing metadata...';
          
          // Disable buttons during sync
          syncButtons.forEach(btn => btn.disabled = true);
          
          // Call the sync API
          const response = await fetch('/api/sync-metadata', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const result = await response.json();
          
          if (result.success) {
            syncStatus.classList.remove('alert-info');
            syncStatus.classList.add('alert-success');
            syncStatus.textContent = `Successfully synchronized ${result.count} scan(s). Refreshing page...`;
            
            // Refresh the page after a short delay
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            throw new Error(result.errors?.join(', ') || 'Unknown error');
          }
        } catch (error) {
          console.error('Error syncing metadata:', error);
          syncStatus.classList.remove('alert-info');
          syncStatus.classList.add('alert-danger');
          syncStatus.textContent = `Error syncing metadata: ${error.message}`;
          
          // Re-enable buttons
          syncButtons.forEach(btn => btn.disabled = false);
        }
      });
    });
  });
  
  // Function to delete a scan via AJAX
  function deleteScan(scanId) {
    // Disable the delete button and show loading state
    const deleteBtn = event.target;
    const originalText = deleteBtn.textContent;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';
    
    // Send the delete request
    fetch(`/api/scans/${scanId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ _method: 'DELETE' })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Create success alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
          <strong>Success!</strong> ${data.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add the alert to the top of the page
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.querySelector(`#deleteConfirmModal${scanId}`));
        modal.hide();
        
        // Remove the scan row from the table
        const scanRow = document.querySelector(`tr[data-scan-id="${scanId}"]`);
        if (scanRow) {
          scanRow.remove();
        } else {
          // If we can't find the row by data attribute, refresh the page
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        }
      } else {
        // Show error message
        alert(`Error: ${data.message}`);
        // Reset the button
        deleteBtn.disabled = false;
        deleteBtn.textContent = originalText;
      }
    })
    .catch(error => {
      console.error('Error deleting scan:', error);
      alert(`Error deleting scan: ${error.message}`);
      // Reset the button
      deleteBtn.disabled = false;
      deleteBtn.textContent = originalText;
    });
  }
</script>
