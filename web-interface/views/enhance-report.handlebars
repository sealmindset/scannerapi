<div class="row">
  <div class="col-lg-8 mx-auto">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Enhance Report with LLM</h2>
      <div>
        <a href="/results/{{scanId}}" class="btn btn-secondary">Back to Results</a>
      </div>
    </div>
    
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Re-enhance Scan Results</h5>
        <p class="card-text">
          This will re-process the existing scan results with a selected LLM provider and model to enhance the vulnerability descriptions and recommendations.
          The original scan results will be preserved, and a new enhanced report will be generated.
        </p>
        
        <form id="enhanceForm">
          <div class="form-group mb-3">
            <label for="provider" class="form-label">LLM Provider</label>
            <select class="form-control" id="provider" name="provider">
              <option value="openai" selected>OpenAI</option>
              <option value="ollama">Ollama</option>
            </select>
          </div>
          
          <div class="form-group mb-3">
            <label for="model" class="form-label">LLM Model</label>
            <select class="form-control" id="model" name="model">
              <option value="gpt-4o" selected>GPT-4o (OpenAI)</option>
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo (OpenAI)</option>
              <option value="llama3.3">Llama 3.3 (Ollama)</option>
              <option value="llama3">Llama 3 (Ollama)</option>
            </select>
          </div>
          
          <div class="d-grid">
            <button type="submit" id="enhanceButton" class="btn btn-primary">Start Enhancement</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Enhancement Progress Card (initially hidden) -->
    <div class="card" id="progressCard" style="display: none;">
      <div class="card-body">
        <h5 class="card-title">Enhancement Progress</h5>
        
        <div class="progress mb-3">
          <div id="enhanceProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div id="progressText" class="text-center mb-3">Initializing enhancement process...</div>
        
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>LLM Enhancement</span>
            <span id="enhanceStatus" class="badge bg-secondary">Pending</span>
          </div>
          <div class="card-body">
            <pre class="output-pre" id="enhanceOutput"></pre>
          </div>
        </div>
        
        <div class="d-grid gap-2">
          <button type="button" id="stopEnhanceBtn" class="btn btn-danger">Stop Enhancement</button>
          <a href="#" id="viewReportBtn" class="btn btn-success" style="display: none;">View Enhanced Report</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Socket.io -->
<script src="/socket.io/socket.io.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    let enhanceSessionId = null;
    let enhanceInProgress = false;
    
    // Handle provider change to update model options
    document.getElementById('provider').addEventListener('change', function() {
      const provider = this.value;
      const modelSelect = document.getElementById('model');
      
      // Clear existing options
      modelSelect.innerHTML = '';
      
      // Add options based on provider
      if (provider === 'openai') {
        modelSelect.innerHTML = `
          <option value="gpt-4o" selected>GPT-4o</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        `;
      } else if (provider === 'ollama') {
        modelSelect.innerHTML = `
          <option value="llama3.3" selected>Llama 3.3</option>
          <option value="llama3">Llama 3</option>
        `;
      }
    });
    
    // Handle form submission
    document.getElementById('enhanceForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (enhanceInProgress) return;
      enhanceInProgress = true;
      
      // Get form values
      const provider = document.getElementById('provider').value;
      const model = document.getElementById('model').value;
      
      // Show progress card
      document.getElementById('progressCard').style.display = 'block';
      document.getElementById('enhanceForm').style.display = 'none';
      
      // Reset output
      document.getElementById('enhanceOutput').textContent = '';
      document.getElementById('enhanceStatus').className = 'badge bg-secondary';
      document.getElementById('enhanceStatus').textContent = 'Pending';
      document.getElementById('viewReportBtn').style.display = 'none';
      
      // Send enhancement request
      fetch(`/api/results/{{scanId}}/enhance`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          provider,
          model
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          enhanceSessionId = data.sessionId;
          
          // Join the enhancement session
          socket.emit('join-scan-session', enhanceSessionId);
          
          // Update UI
          document.getElementById('enhanceStatus').className = 'badge bg-primary';
          document.getElementById('enhanceStatus').textContent = 'In Progress';
          
          // Add message to output
          const output = document.getElementById('enhanceOutput');
          output.textContent += `Starting enhancement with ${provider}/${model}...\n`;
        } else {
          // Handle error
          document.getElementById('enhanceStatus').className = 'badge bg-danger';
          document.getElementById('enhanceStatus').textContent = 'Failed';
          
          // Add error message to output
          const output = document.getElementById('enhanceOutput');
          output.textContent += `Error: ${data.message}\n`;
          
          enhanceInProgress = false;
        }
      })
      .catch(error => {
        console.error('Error starting enhancement:', error);
        
        // Update UI
        document.getElementById('enhanceStatus').className = 'badge bg-danger';
        document.getElementById('enhanceStatus').textContent = 'Failed';
        
        // Add error message to output
        const output = document.getElementById('enhanceOutput');
        output.textContent += `Error: ${error.message}\n`;
        
        enhanceInProgress = false;
      });
    });
    
    // Handle stop enhancement button
    document.getElementById('stopEnhanceBtn').addEventListener('click', function() {
      if (!enhanceSessionId) return;
      
      // Send stop request
      socket.emit('scan-control', {
        action: 'stop',
        sessionId: enhanceSessionId
      });
    });
    
    // Handle socket events
    socket.on('scanner-output', function(data) {
      if (data.type === 'enhance') {
        const output = document.getElementById('enhanceOutput');
        output.textContent += data.data;
        
        // Auto-scroll to bottom
        output.scrollTop = output.scrollHeight;
      }
    });
    
    // Handle enhancement progress updates
    socket.on('enhancement-progress', function(data) {
      // Update progress bar
      const progressBar = document.getElementById('enhanceProgress');
      progressBar.style.width = `${data.percentage}%`;
      progressBar.setAttribute('aria-valuenow', data.percentage);
      
      // Update progress text
      const progressText = document.getElementById('progressText');
      progressText.textContent = `Processing vulnerability ${data.current} of ${data.total} (${data.percentage}%)`;
    });
    
    socket.on('scanner-status', function(data) {
      if (data.type === 'enhance') {
        // Update status badge
        const statusBadge = document.getElementById('enhanceStatus');
        
        if (data.success) {
          statusBadge.className = 'badge bg-success';
          statusBadge.textContent = 'Completed';
        } else {
          statusBadge.className = 'badge bg-danger';
          statusBadge.textContent = 'Failed';
          
          // Add error message to output if not already there
          const output = document.getElementById('enhanceOutput');
          if (!output.textContent.includes(data.output)) {
            output.textContent += `${data.output}\n`;
          }
        }
      }
    });
    
    socket.on('scan-session-state', function(sessionData) {
      if (sessionData.status === 'complete') {
        // Enhancement completed
        enhanceInProgress = false;
        
        // Show view report button
        const viewReportBtn = document.getElementById('viewReportBtn');
        viewReportBtn.href = `/results/${sessionData.scanId}`;
        viewReportBtn.style.display = 'block';
        
        // Hide stop button
        document.getElementById('stopEnhanceBtn').style.display = 'none';
        
        // Update status badge
        const statusBadge = document.getElementById('enhanceStatus');
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Completed';
      }
    });
    
    // Handle process completion event
    socket.on('process-complete', function(data) {
      if (data.type === 'enhance') {
        // Enhancement completed
        enhanceInProgress = false;
        
        // Update progress bar
        const progressBar = document.getElementById('enhanceProgress');
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated');
        
        // Update status badge
        const statusBadge = document.getElementById('enhanceStatus');
        if (data.success) {
          statusBadge.className = 'badge bg-success';
          statusBadge.textContent = 'Completed';
          
          // Show notification
          const output = document.getElementById('enhanceOutput');
          output.textContent += '\nEnhancement completed successfully! You can now view the enhanced report.\n';
          
          // Show view report button
          const viewReportBtn = document.getElementById('viewReportBtn');
          viewReportBtn.href = `/results/{{scanId}}`;
          viewReportBtn.style.display = 'block';
          
          // Hide stop button
          document.getElementById('stopEnhanceBtn').style.display = 'none';
        } else {
          statusBadge.className = 'badge bg-danger';
          statusBadge.textContent = 'Failed';
          
          // Add error message to output
          const output = document.getElementById('enhanceOutput');
          output.textContent += `\nEnhancement failed: ${data.message}\n`;
        }
      }
    });
    
    socket.on('scan-control-response', function(data) {
      if (data.action === 'stop') {
        // Add message to output
        const output = document.getElementById('enhanceOutput');
        output.textContent += `Enhancement stopped by user.\n`;
        
        // Update status
        document.getElementById('enhanceStatus').className = 'badge bg-warning';
        document.getElementById('enhanceStatus').textContent = 'Stopped';
        
        enhanceInProgress = false;
      }
    });
  });
</script>

<style>
  .output-pre {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.875rem;
  }
</style>
