<div class="container mt-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
      <li class="breadcrumb-item active">Scan Details</li>
    </ol>
  </nav>

  <div class="row">
    <!-- Scan Information -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Scan Information</h5>
          <span class="badge {{#if (eq scanDetails.enhanced 'true')}}bg-success{{else}}bg-secondary{{/if}}">
            {{#if (eq scanDetails.enhanced 'true')}}Enhanced with {{scanDetails.provider}} {{scanDetails.model}}{{else}}Not Enhanced{{/if}}
          </span>
        </div>
        <div class="card-body">
          <h3>{{scanDetails.title}}</h3>
          <p class="text-muted">{{scanDetails.description}}</p>
          
          <div class="row mt-4">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">Scan ID</dt>
                <dd class="col-sm-8"><code>{{scanDetails.scanId}}</code></dd>
                
                <dt class="col-sm-4">Target URL</dt>
                <dd class="col-sm-8">{{scanDetails.targetUrl}}</dd>
                
                <dt class="col-sm-4">Created</dt>
                <dd class="col-sm-8">{{formatDate scanDetails.createdAt}}</dd>
                
                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8">
                  <span class="badge bg-{{#if (eq scanDetails.status 'complete')}}success{{else}}secondary{{/if}}">
                    {{scanDetails.status}}
                  </span>
                </dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">Vulnerabilities</dt>
                <dd class="col-sm-8">
                  <span class="badge bg-{{#if (gt scanDetails.vulnerabilityCount 0)}}danger{{else}}success{{/if}}">
                    {{scanDetails.vulnerabilityCount}}
                  </span>
                </dd>
                
                <dt class="col-sm-4">Results File</dt>
                <dd class="col-sm-8">
                  {{#if scanDetails.hasResults}}
                    <span class="text-success"><i class="bi bi-check-circle"></i> Available</span>
                  {{else}}
                    <span class="text-danger"><i class="bi bi-x-circle"></i> Not available</span>
                  {{/if}}
                </dd>
                
                <dt class="col-sm-4">Enhanced Results</dt>
                <dd class="col-sm-8">
                  {{#if scanDetails.hasEnhancedResults}}
                    <span class="text-success"><i class="bi bi-check-circle"></i> Available</span>
                  {{else}}
                    <span class="text-danger"><i class="bi bi-x-circle"></i> Not available</span>
                  {{/if}}
                </dd>
                
                <dt class="col-sm-4">HTML Report</dt>
                <dd class="col-sm-8">
                  {{#if scanDetails.hasReport}}
                    <span class="text-success"><i class="bi bi-check-circle"></i> Available</span>
                  {{else}}
                    <span class="text-danger"><i class="bi bi-x-circle"></i> Not available</span>
                  {{/if}}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="d-grid gap-2">
                <a href="/results/{{scanDetails.scanId}}" class="btn btn-primary">
                  <i class="bi bi-file-text"></i> View Results
                </a>
                {{#if scanDetails.hasReport}}
                  <a href="/reports/report_{{scanDetails.scanId}}.html" target="_blank" class="btn btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right"></i> View HTML Report
                  </a>
                {{/if}}
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-grid gap-2">
                {{#if (eq scanDetails.enhanced 'true')}}
                  <a href="/reports/{{scanDetails.scanId}}/edit" class="btn btn-success">
                    <i class="bi bi-pencil"></i> Edit Enhanced Report
                  </a>
                  <a href="/results/{{scanDetails.scanId}}/enhance" class="btn btn-outline-success">
                    <i class="bi bi-arrow-repeat"></i> Re-enhance with Different Model
                  </a>
                {{else}}
                  <a href="/results/{{scanDetails.scanId}}/enhance" class="btn btn-success">
                    <i class="bi bi-stars"></i> Enhance with LLM
                  </a>
                {{/if}}
              </div>
            </div>
          </div>
          
          <hr>
          
          <div class="row mt-3">
            <div class="col-md-12">
              <div class="d-flex justify-content-between">
                <div>
                  {{#if scanDetails.hasReport}}
                    <a href="/reports/report_{{scanDetails.scanId}}.html" download="report_{{scanDetails.scanId}}.html" class="btn btn-sm btn-outline-secondary">
                      <i class="bi bi-file-earmark-code"></i> Download HTML Report
                    </a>
                  {{/if}}
                  {{#if scanDetails.hasResults}}
                    <a href="/api/results/{{scanDetails.scanId}}/download" class="btn btn-sm btn-outline-secondary">
                      <i class="bi bi-file-earmark-text"></i> Download Original Results
                    </a>
                  {{/if}}
                  {{#if scanDetails.hasEnhancedResults}}
                    <a href="/api/results/{{scanDetails.scanId}}/download?enhanced=true" class="btn btn-sm btn-outline-secondary">
                      <i class="bi bi-file-earmark-richtext"></i> Download Enhanced Results
                    </a>
                  {{/if}}
                </div>
                <div>
                  <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
                    <i class="bi bi-trash"></i> Delete Scan
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Enhancement Panel -->
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">LLM Enhancement</h5>
        </div>
        <div class="card-body">
          {{#if (eq scanDetails.enhanced 'true')}}
            <div class="alert alert-success">
              <h5><i class="bi bi-check-circle"></i> Enhanced Report Available</h5>
              <p>This scan has been enhanced with LLM:</p>
              <ul>
                <li><strong>Provider:</strong> {{scanDetails.provider}}</li>
                <li><strong>Model:</strong> {{scanDetails.model}}</li>
                <li><strong>Enhanced on:</strong> {{formatDate scanDetails.enhancementTimestamp}}</li>
              </ul>
              <div class="d-grid gap-2 mt-3">
                <a href="/reports/{{scanDetails.scanId}}/edit" class="btn btn-primary">
                  <i class="bi bi-pencil"></i> Edit Enhanced Report
                </a>
              </div>
            </div>
            
            <hr>
            
            <h6>Re-enhance with a different model</h6>
            <form id="reenhance-form">
              <div class="mb-3">
                <label for="provider" class="form-label">LLM Provider</label>
                <select class="form-select" id="provider" name="provider" required>
                  {{#each enhancementOptions.providers}}
                    <option value="{{id}}" {{#if (eq ../scanDetails.provider id)}}selected{{/if}}>{{name}}</option>
                  {{/each}}
                </select>
              </div>
              
              <div class="mb-3">
                <label for="model" class="form-label">LLM Model</label>
                <select class="form-select" id="model" name="model" required>
                  <!-- Options will be populated by JavaScript -->
                </select>
              </div>
              
              <div class="d-grid">
                <button type="button" id="reenhance-btn" class="btn btn-outline-primary">
                  <i class="bi bi-arrow-repeat"></i> Re-enhance Results
                </button>
              </div>
            </form>
          {{else}}
            <div class="alert alert-secondary">
              <h5><i class="bi bi-info-circle"></i> Not Enhanced</h5>
              <p>This scan has not been enhanced with LLM yet. Enhancement adds detailed explanations, risk assessments, and remediation advice for each vulnerability.</p>
            </div>
            
            <form action="/api/results/{{scanDetails.scanId}}/enhance" method="POST" id="enhance-form">
              <div class="mb-3">
                <label for="provider" class="form-label">LLM Provider</label>
                <select class="form-select" id="provider" name="provider" required>
                  {{#each enhancementOptions.providers}}
                    <option value="{{id}}">{{name}}</option>
                  {{/each}}
                </select>
              </div>
              
              <div class="mb-3">
                <label for="model" class="form-label">LLM Model</label>
                <select class="form-select" id="model" name="model" required>
                  <!-- Options will be populated by JavaScript -->
                </select>
              </div>
              
              <div class="d-grid">
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-brain"></i> Enhance Results
                </button>
              </div>
            </form>
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this scan and all associated files?</p>
        <p class="text-danger"><strong>Warning:</strong> This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="deleteScan('{{scanDetails.scanId}}')">Delete Permanently</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Model selection based on provider
    const providerSelect = document.getElementById('provider');
    const modelSelect = document.getElementById('model');
    const modelOptions = {{{json enhancementOptions.models}}};
    
    function updateModelOptions() {
      const selectedProvider = providerSelect.value;
      const models = modelOptions[selectedProvider] || [];
      
      // Clear existing options
      modelSelect.innerHTML = '';
      
      // Add new options
      models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.name;
        modelSelect.appendChild(option);
      });
    }
    
    // Initialize model options
    updateModelOptions();
    
    // Update model options when provider changes
    providerSelect.addEventListener('change', updateModelOptions);
  });
  
  // Function to delete a scan via AJAX
  function deleteScan(scanId) {
    // Disable the delete button and show loading state
    const deleteBtn = event.target;
    const originalText = deleteBtn.textContent;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';
    
    // Send the delete request
    fetch(`/api/scans/${scanId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ _method: 'DELETE' })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Create success alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
          <strong>Success!</strong> ${data.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add the alert to the top of the page
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.querySelector('#deleteConfirmModal'));
        modal.hide();
        
        // Redirect to dashboard after a short delay
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 1500);
      } else {
        // Show error message
        alert(`Error: ${data.message}`);
        // Reset the button
        deleteBtn.disabled = false;
        deleteBtn.textContent = originalText;
      }
    })
    .catch(error => {
      console.error('Error deleting scan:', error);
      alert(`Error deleting scan: ${error.message}`);
      // Reset the button
      deleteBtn.disabled = false;
      deleteBtn.textContent = originalText;
    });
  }
  
  // Handle re-enhance button click
  document.getElementById('reenhance-btn').addEventListener('click', function() {
    const provider = document.getElementById('provider').value;
    const model = document.getElementById('model').value;
    
    // Open the enhancement modal in a new window
    const enhanceUrl = `/results/{{scanDetails.scanId}}/enhance?provider=${encodeURIComponent(provider)}&model=${encodeURIComponent(model)}`;
    const enhanceWindow = window.open(enhanceUrl, 'enhanceWindow', 'width=800,height=700');
    
    // Focus the new window
    if (enhanceWindow) {
      enhanceWindow.focus();
    }
  });
</script>
